---
title: "Origon Forest Fire Script"
objectives:
- Extract summary pixel values from a raster.
- Save summary values to a .csv file.
- Plot summary pixel values using `ggplot()`.
- Compare NDVI values between two different sites.
output:
  html_document:
    df_print: paged
keypoints:
- Use the `cellStats()` function to calculate summary statistics for cells in a raster
  object.
- The pipe (`|`) operator means `or`.
- Use the `rbind()` function to combine data frames that have the same column names.
---

# Loading required package
```{r load-libraries, echo=FALSE, message=FALSE, warning=FALSE, results='hide'}
library(raster)
library(RStoolbox)
library(rgdal)
library(ggplot2)
library(dplyr)
library(dplyr)
library(viridis)
library(rasterVis)
library(devtools)
library(slidaRtools)

```

# Loading the MetaData and Raster file
```{r load-data, echo=FALSE, results='hide'}
setwd("C:/FIT/Research-Project/Code/")
AOI <- readOGR("data/AOI.shp")
# Pre fire Raster and metaData
metaData_pre <- readMeta("data/LC08_L1TP_045029_20200901_20200906_01_T1/LC08_L1TP_045029_20200901_20200906_01_T1_MTL.txt")
metaStack_pre <- stackMeta(metaData_pre)
plot(metaStack_pre)
# Post fire Raster and metaData
metaData_post <- readMeta("data/LC08_L1TP_045029_20201003_20201015_01_T1/LC08_L1TP_045029_20201003_20201015_01_T1_MTL.txt")
metaStack_post <- stackMeta(metaData_post)
plot(metaStack_post)
```

# Image Pre Processing
```{r image-preprocessing, echo=FALSE, results='hide'}
# DOS Correction pre fire images and saving stack raster as geoTiff
LS8_pre_dos <- radCor(metaStack_pre, metaData_pre, method = "dos", bandSet = c(2,3,4,5,7))
writeRaster(LS8_pre_dos, filename="output/LS8_pre_dos.tif", bandorder='BIL', overwrite=TRUE)
# DOS Correction post fire images and saving stack raster as geoTiff
LS8_post_dos <- radCor(metaStack_post, metaData_post, method = "dos", bandSet = c(2,3,4,5,7))
writeRaster(LS8_post_dos, filename="output/LS8_post_dos.tif", bandorder='BIL', overwrite=TRUE)
# Load the processed raster
LS8_pre <- brick("output/LS8_pre_dos.tif")
LS8_post <- brick("output/LS8_post_dos.tif")
# Names of the bands
names(LS8_pre[[1]])
# Ploting the RGB images of Pre fire and Post fire area
plotRGB(LS8_pre_dos, r=3, g=2, b=1, stretch="lin")
plotRGB(LS8_post_dos, r=3, g=2, b=1, stretch="lin")
```

# Calculating pre and post NBR and dNBR
```{r pre-post-nbr, echo=FALSE, results='hide'}
# Function for NBR calculation
nbr <- function(img){
  br <- (img[[4]]-img[[5]])/(img[[4]]+img[[5]])
  return(br)
}
# Calculating pre and post fire NBR
nbr_LS8_pre <- calc(LS8_pre, fun = nbr)
nbr_LS8_post <- calc(LS8_post, fun = nbr)
# Difference in NBR
nbr_diff <- (nbr_LS8_pre - nbr_LS8_post)
# crop by the extent
nbr_diff_crop <- crop(nbr_diff,extent(AOI))
nbr_diff_crop <- mask(nbr_diff_crop, AOI)
plot(nbr_diff_crop, col = rev(terrain.colors(10)), main = 'dNBR')
```

# Classification of NBR
```{r nbr-classification, echo=FALSE, results='hide'}
reclass_df <- c (-Inf, -0.5, 0, # out of range - no data
                 -0.1, 0.099, 1, # unburned area
                 0.1, 0.269, 2, # low severity
                 0.27, 0.659, 3, # moderate severity
                 0.66, 1.3, 4, # high severity
                 1.31, +Inf, 0) # out of range - no data
reclass_m <- matrix(reclass_df, ncol=3, byrow=TRUE)
nbr_diff_reclass <- reclassify(nbr_diff_crop, reclass_m)
legend_val <- c("NA values",
                "Unburned",
                "Low-severity",
                "Moderate-severity",
                "High-severity"
                )
col_val <-  c("#6CD545","#28FFA0","#F3FF28","#F29029","#CE29F2")

jpeg('output/burnseverity20200906vs20201015.jpg',width = 1000, 
     height = 800, res=200, units = "px", quality = 100, pointsize=10)
par(mar=c(4,8,4,4))
plot(nbr_diff_reclass, 
     main="Burn Severity Map of Lionshead",
     col = col_val,
     axes=F,
     box=F,
     legend=F)+
  legend('topright',
       legend = legend_val ,fill=col_val,
       inset=c(-0.25,0), pt.cex=0.7,cex=0.7,
       xpd = T, bty='n')
dev.off()
# Saving the dNBR as tif
writeRaster(nbr_diff_reclass, filename = "output/burnseverity20200906vs20201015.tif", format="GTiff", overwrite=T)
```

```{r LiDAR, echo=FALSE, results='hide'}
library(lidR)
library(data.table)
library(tidyverse)
las <- readLAS('data/FPC_WILSWH_439500_1186500_20160803.laz')
head(las)
nbr_diff_reclass <- raster('output/burnseverity20200906vs20201015.tif')
crs <- projection(AOI)
nbr <- projectRaster(nbr_diff_reclass, crs = crs)
writeRaster(nbr, filename = "output/nbr_reproj.tif", format="GTiff", overwrite=T)

hmean <- grid_metrics(las, ~mean(Z), 30) # calculate mean at 30 m
crs(hmean) <- crs
writeRaster(hmean,filename = "output/hmean_reproj.tif", format="GTiff", overwrite=T)

extent(hmean)
head(hmean)
extent(nbr)

resample <- resample(nbr, hmean, method="bilinear")

rstack <- stack(resample, hmean)
d <- values(rstack)
plot(d)

plot(resample)
reg <- as.data.frame(rstack, xy = T)
reg <- reg %>%
  rename(
    burn_index = burnseverity20200906vs20201015,
    mean_Z = V1
  )
reg
plot(reg)
write.csv(reg, file = 'output/dataframe.csv')
plot(nbr_diff_reclass, add = TRUE)

```

